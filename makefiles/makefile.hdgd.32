SHELL=bash
pwd=${shell pwd}

#====== control 
use_debug=0
use_sdk=1
use_auth=0
use_mbedtls=0
use_openssl=0
use_timelimit=0
use_count=0
use_ksdebnf=1
use_32to8ms=0
use_keros=0
use_enc8838=0
use_aec=0
use_asr=1
use_ahs=0
use_bfio=0
use_consist=0
use_gainnetbf=1
use_gdenoise=1
use_estimate=1
use_qform=1
use_eqform=1
use_beamnet=1
use_soundscreen=1
use_eval=0
use_kvad=0
use_semdlg=0
use_ssl=1
use_tinybf=0
use_tts=0
use_vad=0
use_vboxebf=1
use_vboxebf3=1
use_ult=0
use_wakeup=0
use_wdec=0
use_kws=0
use_onnx=1
use_ncnn=0
use_csrsc=0
use_resample=1
use_noserver=0
use_module_mqform=0
use_module_mqform2=0
use_module_mgainnet=0
use_module_qform=0
#========================= src ========================================

src_dir=third/json third/sqlite third/nosqlite third/lapack wtk/bfio wtk/core wtk/tts wtk/dnnc wtk/lex wtk/lua wtk/semdlg wtk/asr
ifeq ($(use_sdk), 1)
src_dir+=wtk/http/misc/cookie  wtk/http/misc/httpc sdk qtk/dns
else
src_dir+=sdk/api_1 qtk/play qtk/record sdk/codec sdk/dev
endif

src_dir+=qtk/sci/clustering qtk/linalg qtk/nnrt

ifeq ($(use_ult), 1)
src_dir+=qtk/ult qtk/mdl qtk/sci/filter qtk/sci/optimize qtk/sci/stats
endif

src_c=${shell find $(src_dir) -name "*.c"}

src_c+=wtk/os/wtk_blockqueue.c wtk/os/wtk_sem.c  wtk/os/wtk_thread.c wtk/os/wtk_log.c wtk/os/wtk_log_cfg.c  wtk/os/wtk_lockqueue.c wtk/os/wtk_lockhoard.c  wtk/os/wtk_time.c   wtk/os/wtk_fd.c  wtk/os/wtk_socket.c wtk/os/wtk_thread2.c wtk/os/wtk_lockvpool.c  wtk/os/wtk_pipequeue.c wtk/os/wtk_cpu.c wtk/os/wtk_proc.c wtk/os/wtk_pid.c

src_c+=qtk/core/qtk_min_heap.c

ifeq ($(use_sdk), 1)

ifeq ($(use_mbedtls), 1)
src_c+=${shell find ./third/mbedtls/library -name "*.c"}
endif

src_c+=wtk/http/misc/wtk_http_response.c wtk/http/misc/wtk_http_chunk.c wtk/http/misc/wtk_http_util.c
src_c+=./third/lua/lapi.c \
./third/lua/lauxlib.c \
./third/lua/lbaselib.c \
./third/lua/lcode.c \
./third/lua/lcorolib.c \
./third/lua/lctype.c \
./third/lua/ldblib.c \
./third/lua/ldebug.c \
./third/lua/ldo.c \
./third/lua/ldump.c \
./third/lua/lfunc.c \
./third/lua/lgc.c \
./third/lua/linit.c \
./third/lua/liolib.c \
./third/lua/llex.c \
./third/lua/lmathlib.c \
./third/lua/lmem.c \
./third/lua/loadlib.c \
./third/lua/lobject.c \
./third/lua/lopcodes.c \
./third/lua/loslib.c \
./third/lua/lparser.c \
./third/lua/lstate.c \
./third/lua/lstring.c \
./third/lua/lstrlib.c \
./third/lua/ltable.c \
./third/lua/ltablib.c \
./third/lua/ltm.c \
./third/lua/lundump.c \
./third/lua/lutf8lib.c \
./third/lua/lvm.c \
./third/lua/lzio.c

#src_c+=${shell find ./third/speexdsp-1.2rc3/libspeexdsp -name "*.c"}
src_c+=./third/speex/libspeex/bits.c\
./third/speex/libspeex/cb_search.c\
./third/speex/libspeex/exc_10_16_table.c\
./third/speex/libspeex/exc_10_32_table.c\
./third/speex/libspeex/exc_20_32_table.c\
./third/speex/libspeex/exc_5_256_table.c\
./third/speex/libspeex/exc_5_64_table.c\
./third/speex/libspeex/exc_8_128_table.c\
./third/speex/libspeex/filters.c\
./third/speex/libspeex/gain_table.c\
./third/speex/libspeex/gain_table_lbr.c\
./third/speex/libspeex/hexc_10_32_table.c\
./third/speex/libspeex/hexc_table.c\
./third/speex/libspeex/high_lsp_tables.c\
./third/speex/libspeex/kiss_fft.c\
./third/speex/libspeex/kiss_fftr.c\
./third/speex/libspeex/lpc.c\
./third/speex/libspeex/lsp.c\
./third/speex/libspeex/lsp_tables_nb.c\
./third/speex/libspeex/ltp.c\
./third/speex/libspeex/modes.c\
./third/speex/libspeex/modes_wb.c\
./third/speex/libspeex/nb_celp.c\
./third/speex/libspeex/quant_lsp.c\
./third/speex/libspeex/sb_celp.c\
./third/speex/libspeex/smallft.c\
./third/speex/libspeex/speex.c\
./third/speex/libspeex/speex_callbacks.c\
./third/speex/libspeex/speex_header.c\
./third/speex/libspeex/stereo.c\
./third/speex/libspeex/vbr.c\
./third/speex/libspeex/vorbis_psy.c\
./third/speex/libspeex/vq.c\
./third/speex/libspeex/window.c\
./third/speexdsp/libspeexdsp/buffer.c\
./third/speexdsp/libspeexdsp/filterbank.c\
./third/speexdsp/libspeexdsp/jitter.c\
./third/speexdsp/libspeexdsp/mdf.c\
./third/speexdsp/libspeexdsp/preprocess.c\
./third/speexdsp/libspeexdsp/resample.c\
./third/speexdsp/libspeexdsp/scal.c\
./third/speexdsp/libspeexdsp/fftwrap.c\
./third/libogg/src/bitwise.c  \
./third/libogg/src/framing.c

src_c+=./third/libmad-0.15.1b/huffman.c\
./third/libmad-0.15.1b/synth.c \
./third/libmad-0.15.1b/bit.c \
./third/libmad-0.15.1b/frame.c\
./third/libmad-0.15.1b/version.c\
./third/libmad-0.15.1b/timer.c\
./third/libmad-0.15.1b/layer3.c\
./third/libmad-0.15.1b/stream.c\
./third/libmad-0.15.1b/decoder.c\
./third/libmad-0.15.1b/fixed.c\
./third/libmad-0.15.1b/layer12.c

src_c+=third/libuuid/clear.c \
third/libuuid/compare.c \
third/libuuid/copy.c \
third/libuuid/gen_uuid.c \
third/libuuid/isnull.c \
third/libuuid/pack.c \
third/libuuid/parse.c \
third/libuuid/randutils.c \
third/libuuid/unpack.c \
third/libuuid/unparse.c \
third/libuuid/uuid_time.c \

else
src_c+=sdk/qtk_comm.c sdk/qtk_mod_cfg.c sdk/qtk_mod.c sdk/qtk_mod_am60_cfg.c sdk/qtk_mod_am60.c sdk/qtk_mod2_cfg.c sdk/qtk_mod2.c sdk/qtk_mod_double_cfg.c sdk/qtk_mod_double.c sdk/qtk_mod_ult_cfg.c sdk/qtk_mod_ult.c sdk/qtk_mod_consist.c sdk/qtk_mod_consist_cfg.c sdk/qtk_mod_rp.c sdk/qtk_mod_rp_cfg.c sdk/qtk_uart_client.c sdk/qtk_uart_client_cfg.c
src_c+=./third/speex/libspeex/bits.c\
./third/speex/libspeex/cb_search.c\
./third/speex/libspeex/exc_10_16_table.c\
./third/speex/libspeex/exc_10_32_table.c\
./third/speex/libspeex/exc_20_32_table.c\
./third/speex/libspeex/exc_5_256_table.c\
./third/speex/libspeex/exc_5_64_table.c\
./third/speex/libspeex/exc_8_128_table.c\
./third/speex/libspeex/filters.c\
./third/speex/libspeex/gain_table.c\
./third/speex/libspeex/gain_table_lbr.c\
./third/speex/libspeex/hexc_10_32_table.c\
./third/speex/libspeex/hexc_table.c\
./third/speex/libspeex/high_lsp_tables.c\
./third/speex/libspeex/kiss_fft.c\
./third/speex/libspeex/kiss_fftr.c\
./third/speex/libspeex/lpc.c\
./third/speex/libspeex/lsp.c\
./third/speex/libspeex/lsp_tables_nb.c\
./third/speex/libspeex/ltp.c\
./third/speex/libspeex/modes.c\
./third/speex/libspeex/modes_wb.c\
./third/speex/libspeex/nb_celp.c\
./third/speex/libspeex/quant_lsp.c\
./third/speex/libspeex/sb_celp.c\
./third/speex/libspeex/smallft.c\
./third/speex/libspeex/speex.c\
./third/speex/libspeex/speex_callbacks.c\
./third/speex/libspeex/speex_header.c\
./third/speex/libspeex/stereo.c\
./third/speex/libspeex/vbr.c\
./third/speex/libspeex/vorbis_psy.c\
./third/speex/libspeex/vq.c\
./third/speex/libspeex/window.c\
./third/speexdsp/libspeexdsp/buffer.c\
./third/speexdsp/libspeexdsp/filterbank.c\
./third/speexdsp/libspeexdsp/jitter.c\
./third/speexdsp/libspeexdsp/mdf.c\
./third/speexdsp/libspeexdsp/preprocess.c\
./third/speexdsp/libspeexdsp/resample.c\
./third/speexdsp/libspeexdsp/fftwrap.c\
./third/speexdsp/libspeexdsp/scal.c\
./third/libogg/src/bitwise.c\
./third/libogg/src/framing.c
endif

exclude_dir=sdk/dev/enc sdk/dev/hid sdk/dev/key sdk/dev/led sdk/dev/wifi sdk/binding

ifeq ($(use_sdk), 1)
exclude_dir += sdk/audio sdk/module #/daemon sdk/audio/usb sdk/audio/util
ifneq ($(use_auth),1)
exclude_dir += sdk/session/auth
endif
endif
exclude_dir+=sdk/codec/opus sdk/mulsv
ifneq ($(use_asr), 1)
	exclude_dir += sdk/engine/asr sdk/api_1/asr
	exclude_dir += sdk/engine/csr sdk/api_1/csr
endif
ifneq ($(use_csrsc), 1)
	exclude_dir += sdk/engine/ecsrsc sdk/api_1/csrsc
endif
ifneq ($(use_bfio), 1)
	exclude_dir += sdk/engine/bfio sdk/api_1/bfio
endif
ifneq ($(use_consist), 1)
	exclude_dir += sdk/engine/consist
endif
ifneq ($(use_gainnetbf), 1)
	exclude_dir += sdk/engine/egainnetbf sdk/api_1/gainnetbf
endif
ifneq ($(use_gdenoise), 1)
	exclude_dir += sdk/engine/egdenoise sdk/api_1/gdenoise
endif
ifneq ($(use_estimate), 1)
	exclude_dir += sdk/engine/eestimate sdk/api_1/estimate
endif
ifneq ($(use_qform), 1)
	exclude_dir += sdk/engine/eqfrom sdk/api_1/qform
endif
ifneq ($(use_eqform), 1)
	exclude_dir += sdk/engine/eeqfrom sdk/api_1/eqform
endif
ifneq ($(use_beamnet), 1)
	exclude_dir += sdk/api_1/beamnet
endif
ifneq ($(use_soundscreen), 1)
	exclude_dir += sdk/engine/esoundscreen sdk/api_1/soundScreen
endif
ifneq ($(use_eval), 1)
	exclude_dir += sdk/engine/eval sdk/api_1/eval
endif
ifneq ($(use_kvad), 1)
	exclude_dir += sdk/engine/kvad
endif
ifneq ($(use_semdlg), 1)
	exclude_dir += sdk/engine/semdlg sdk/api_1/semdlg
endif
ifneq ($(use_ssl), 1)
	exclude_dir += sdk/engine/ssl sdk/api_1/ssl
endif
ifneq ($(use_tinybf), 1)
	exclude_dir += sdk/engine/tinybf
endif
ifneq ($(use_tts), 1)
	exclude_dir += sdk/engine/tts sdk/api_1/tts
	exclude_dir += wtk/tts
endif
ifneq ($(use_vad), 1)
	exclude_dir += sdk/engine/vad
endif
ifneq ($(use_vboxebf), 1)
	exclude_dir += sdk/engine/vboxebf sdk/api_1/vboxebf
endif
ifneq ($(use_vboxebf3), 1)
	exclude_dir += sdk/engine/vboxebf3
endif
ifneq ($(use_wakeup), 1)
	exclude_dir += sdk/engine/wakeup sdk/api_1/wakeup
endif
ifneq ($(use_wdec), 1)
	exclude_dir += sdk/engine/wdec sdk/api_1/wdec
endif
ifneq ($(use_kws),1)
        exclude_dir += sdk/engine/eqkws sdk/api_1/kws
endif
ifneq ($(use_ult), 1)
	exclude_dir += sdk/api_1/ultrasonic sdk/module/mult
endif

ifeq ($(use_asr)_$(use_vad)_$(use_kvad)_$(use_semdlg)_$(use_wakeup)_$(use_wdec)_$(use_kws), 0_0_0_0_0_0_0)
exclude_dir += wtk/asr
endif
exclude_dir+=sdk/codec/opus
exclude_c=${shell find $(exclude_dir) -name "*.c"}
ifneq ($(use_bfio), 1)
	exclude_c+=wtk/bfio/wtk_bfio.c wtk/bfio/wtk_bfio_cfg.c wtk/bfio/wtk_bfio3.c wtk/bfio/wtk_bfio3_cfg.c wtk/bfio/wtk_bfio4.c wtk/bfio/wtk_bfio4_cfg.c wtk/bfio/wtk_kvadwake.c wtk/bfio/wtk_kvadwake_cfg.c
endif
ifneq ($(use_asr), 1)
	exclude_c+=wtk/bfio/qtk_wasr.c wtk/bfio/qtk_wasr_cfg.c wtk/bfio/qtk_fixed_angle_wasr.c wtk/bfio/qtk_fixed_angle_wasr_cfg.c
endif
exclude_c+=third/sqlite/shell.c wtk/bfio/ahs/qtk_kalman.c
ifeq ($(use_sdk), 1)
exclude_c+=sdk/qtk_mod.c sdk/qtk_mod_cfg.c sdk/qtk_mod_am60_cfg.c sdk/qtk_mod_am60.c sdk/qtk_mod2_cfg.c sdk/qtk_mod2.c sdk/qtk_mod_double_cfg.c sdk/qtk_mod_double.c sdk/qtk_mod_ult.c sdk/qtk_mod_ult_cfg.c sdk/qtk_mod_consist.c sdk/qtk_mod_consist_cfg.c sdk/qtk_mod_rp.c sdk/qtk_mod_rp_cfg.c sdk/audio/qtk_audio.c sdk/audio/qtk_audio_cfg.c sdk/audio/qtk_auin.c sdk/audio/qtk_auin_cfg.c sdk/audio/qtk_auout.c sdk/audio/qtk_auout_cfg.c #sdk/qtk_uart_client.c sdk/qtk_uart_client_cfg.c
ifeq ($(use_ksdebnf), 1)
exclude_c+=wtk/asr/api/qvoice_asr_api.c wtk/bfio/aec/cmask_aec/wtk_cmask_aec.c
endif
endif
exclude_cpp=${shell find $(exclude_dir) -name "*.cpp"}

src_f_c=$(filter-out $(exclude_c),$(src_c))
c_objs=$(patsubst %.c,%.o,$(src_f_c))
src_cpp=${shell find $(src_dir) -name "*.cpp"}
src_f_cpp=$(filter-out $(exclude_cpp),$(src_cpp))
cpp_objs=$(patsubst %.cpp,%.o,$(src_f_cpp))
src_neon=${shell find ${src_dir} -name "*.neon"}
neon_objs=$(patsubst %.neon,%.o,$(src_neon))
lib_objs=$(c_objs) $(cpp_objs) $(neon_objs)

objs=$(lib_objs) 

ifneq ($(use_sdk), 1)
tool_src= ./test/tool/sdk/process/Qsound_301.c
tool_src += ./test/tool/sdk/process/mod_consist.c
tool_src += ./test/tool/sdk/process/qsound_rp.c
else
tool_src += ./test/tool/sdk/process/engine.c
tool_src += ./test/tool/sdk/process/engine-asr.c
#tool_src += ./test/tool/sdk/process/mqform.c
#tool_src += ./test/tool/sdk/process/module.c
endif
#tool_src += ./test/tool/key.c
#tool_src += ./test/tool/uart.c
#tool_src += ./test/tool/wifi.c
#tool_src += ./test/tool/uart2.c
#tool_src += ./test/tool/rcd.c
#tool_src += ./test/tool/audio.c
#tool_src += ./test/tool/sdk/process/led.c
#tool_src += ./test/tool/sdk/process/echoshift.c
tool_src += ./test/tool/sdk/process/speexresample.c
tool_src += ./test/tool/sdk/process/consist.c

tool_src += ./test/tool/sdk/process/vboxebf3.c
tool_src += ./test/tool/sdk/process/vboxebf4.c
tool_src += ./test/tool/sdk/process/mix_speech.c
tool_src += ./test/tool/sdk/process/vboxebf6.c
tool_src += ./test/tool/sdk/process/gainnet_bf4.c
ifeq ($(use_kws), 1)
tool_src += ./test/tool/asr/svp-enroll.c
tool_src += ./test/tool/asr/svp-eval.c
endif
tool_objs= $(patsubst %.c,%.o,$(tool_src))
tool_obj= $(patsubst %.c,%,$(tool_src))
######################################################

######################### lib section #####################################
ifeq ($(use_sdk), 1)
libusb=./third/libusb-1.0.20/libusb.a
libcrypto=./third/openssl/libcrypto.a
libgprof=./third/android-ndk-profiler-master/obj/local/armeabi/libandroid-ndk-profiler.a

libs=

ifeq ($(use_usb),1)
	libs+= ${libusb}
endif
endif
############################################################################

############### compile section ###############
BIN_PATH=/home/why/tool/huaDongGuangDian/gcc-7.5/bin

CC=${BIN_PATH}/arm-linux-gnueabihf-gcc
CXX=${BIN_PATH}/arm-linux-gnueabihf-g++
AS=${BIN_PATH}/arm-linux-gnueabihf-as
STRIP=${BIN_PATH}/arm-linux-gnueabihf-strip


INC =-I . -I ./sdk/api_1 -I ./sdk -I ./qtk -I ./third -I ./third/libmad-0.15.1b -I ./third/libogg/include/ -I ./third/libmad-0.15.1b/msvc++ -I ./third/speexdsp/include -I ./third/speex/include -I ./third/speexdsp/include/speex -I ./third/libuuid -I ./third/arm/alsa-lib-1.1.5/include

ifeq ($(use_openssl), 1)
        INC += -I ./third/openssl/include
endif
ifeq ($(use_mbedtls), 1)
        INC += -I third/mbedtls/include
endif

ifeq ($(use_onnx), 1)
	INC += -I third/onnxruntime/onnxaarch32-hdgd-1.11.1/include
endif

ifeq ($(use_ncnn), 1)
	INC += -I third/ncnn/build_lixun_3308_64/include
endif


DNN_CFLAG=-fsigned-char
DNN_CFLAG+= -mfpu=neon -march=armv7-a -mtune=cortex-a9 #-mfloat-abi=hard

ifeq ($(use_debug), 1)
OF= -g -ffunction-sections -fdata-sections
else
OF= -O3 -ffast-math -Ofast -Wall -funroll-loops -Wno-unused-result -fomit-frame-pointer -ffunction-sections -fdata-sections
endif
WFLAGS=-Wall 
CFLAGS= $(OF) $(INC) ${WFLAGS} ${DNN_CFLAG}

CFLAGS +=-DUSE_CHAR_NET -DUSE_SQL -DUSE_ALIGN -DFIXED_POINT -DUSE_KISS_FFT -DEXPORT="" -DHAVE_USLEEP -D_GNU_SOURCE #-DUSE_NEON #-DUSE_FOR_DEV# -DOFFLINE_TEST#-DQTK_MEM_CHECK
ifeq ($(use_debug), 0)
#CFLAGS +=-DUSE_NEON 
endif

ifeq ($(use_uac), 1)
CFLAGS +=-DUSE_UAC
endif

ifeq ($(use_sdk), 1)
CFLAGS +=-D USE_DUMMY_ICONV -DHAVE_CONFIG_H -DFPM_ARM -DOPUS_BUILD -DUSE_ALLOCA -fPIC #-shared
endif

ifeq ($(use_debug), 1)
LFLAGS=-ldl -lpthread -lm -lasound -L ./third/r311 -lwifimg -lcrypto
else
LFLAGS=-ldl -Wl,-O1 -Wl,--hash-style=gnu -Wl,--as-needed -lpthread -lm #-lasound #-L ./third/r311 -lwifimg -lcrypto
endif

ifeq ($(use_keros), 1)
	LFLAGS+=-L./third/ktc -lKeros_aarch64-linux-gnu_Cid8025
endif
#============================================================================================

ifeq ($(use_onnx), 1)
	LFLAGS += -lonnxruntime -L./third/onnxruntime/onnxaarch32-hdgd-1.11.1/lib
endif

ifeq ($(use_ncnn), 1)
	LFLAGS += -lncnn -L./third/ncnn/build_lixun_3308_64/lib
endif


ifeq ($(use_timelimit),1)
	CFLAGS += -DUSE_TIMELIMIT
endif
ifeq ($(use_count), 1)
	CFLAGS += -DUSE_QTKCOUNT
endif

ifeq ($(use_usb),1)
	CFLAGS += -DUSE_USB
endif
ifeq ($(use_aec),1)
	CFLAGS += -DUSE_AEC
endif
ifeq ($(use_asr),1)
	CFLAGS += -DUSE_ASR
endif
ifeq ($(use_bfio),1)
	CFLAGS += -DUSE_BFIO
endif
ifeq ($(use_consist),1)
	CFLAGS += -DUSE_CONSIST
endif
ifeq ($(use_gainnetbf),1)
	CFLAGS += -DUSE_GAINNETBF
endif
ifeq ($(use_gdenoise),1)
	CFLAGS += -DUSE_GDENOISE
endif
ifeq ($(use_estimate),1)
	CFLAGS += -DUSE_ESTIMATE
endif
ifeq ($(use_qform),1)
	CFLAGS += -DUSE_QFORM
endif
ifeq ($(use_eqform),1)
	CFLAGS += -DUSE_EQFORM
endif
ifeq ($(use_beamnet),1)
	CFLAGS += -DUSE_BEAMNET
endif
ifeq ($(use_soundscreen),1)
	CFLAGS += -DUSE_SOUNDSCREEN
endif
ifeq ($(use_eval),1)
	CFLAGS += -DUSE_EVAL
endif
ifeq ($(use_kvad),1)
	CFLAGS += -DUSE_KVAD
endif
ifeq ($(use_semdlg),1)
	CFLAGS += -DUSE_SEMDLG
endif
ifeq ($(use_ssl),1)
	CFLAGS += -DUSE_SSL
endif
ifeq ($(use_tinybf),1)
	CFLAGS += -DUSE_TINYBF
endif
ifeq ($(use_tts),1)
	CFLAGS += -DUSE_TTS
endif
ifeq ($(use_vad),1)
	CFLAGS += -DUSE_VAD
endif
ifeq ($(use_vboxebf),1)
	CFLAGS += -DUSE_VBOXEBF
endif
ifeq ($(use_vboxebf3),1)
	CFLAGS += -DUSE_VBOXEBF3
endif
ifeq ($(use_wakeup),1)
	CFLAGS += -DUSE_WAKEUP
endif
ifeq ($(use_wdec),1)
	CFLAGS += -DUSE_WDEC
endif
ifeq ($(use_kws),1)
	CFLAGS += -DUSE_QKWS
endif
ifeq ($(use_ahs),1)
	CFLAGS += -DUSE_AHS
endif
ifeq ($(use_resample),1)
	CFLAGS += -DUSE_RESAMPLE
endif
ifeq ($(use_onnx),1) 
        CFLAGS += -DONNX_DEC 
endif
ifeq ($(use_ncnn),1)
	CFLAGS += -DQTK_NNRT_NCNN
endif
ifeq ($(use_csrsc),1)
	CFLAGS += -DUSE_CSRSC
endif

ifeq ($(use_sdk), 1)
ifeq ($(use_module_mqform), 1)
        CFLAGS += -DUSE_MODULE_MQFORM
endif
ifeq ($(use_module_mqform2), 1)
        CFLAGS += -DUSE_MODULE_MQFORM2
endif
ifeq ($(use_module_mgainnet), 1)
        CFLAGS += -DUSE_MODULE_MGAINNET
endif
ifeq ($(use_module_qform), 1)
        CFLAGS += -DUSE_MODULE_QFORM
endif

ifeq ($(use_noserver), 1)
        CFLAGS += -DUSE_NOSERVER
endif

ifeq ($(use_auth),1)
	CFLAGS += -DUSE_AUTH
ifeq ($(use_openssl), 1)
        CFLAGS += -DUSE_OPENSSL
endif
ifeq ($(use_mbedtls), 1)
        CFLAGS += -DUSE_MBEDTLS
endif
endif
libso=libs/arm/libqvoice.so
endif

ifeq ($(use_keros), 1)
	CFLAGS += -DUSE_KEROS
endif

ifeq ($(use_enc8838), 1)
	CFLAGS += -DUSE_ENC8838
endif

ifeq ($(use_run_timelimit),1)
	CFLAGS += -DUSE_RUN_TIMELIMIT
endif

ifeq ($(use_ksdebnf),1)
        CFLAGS += -DUSE_KSD_EBNF
endif

ifeq ($(use_32to8ms),1)
        CFLAGS += -DUSE_32MSTO8MS
endif


ifeq ($(use_303),1)
	CFLAGS += -DUSE_303
endif

%.o:%.neon
	cp $< neon.c
	$(CC) $(CFLAGS) -c -o $@ neon.c; 
%.o:%.c
	$(CC) $(CFLAGS) -c -o $@ $<;  
%.o:%.cpp
	$(CXX) $(CFLAGS) -c -o $@ $<


all: ${libs} tool

ifeq ($(use_sdk), 1)
tool: $(objs) $(tool_objs)
	$(CXX) $(CFLAGS) -shared  -o ${libso} $(lib_objs) $(LFLAGS)
	${STRIP} ${libso}	
	for i in $(tool_obj);\
		do echo $${i};\
		$(CC) $(CFLAGS) -Wl,--gc-sections -c -o $${i}.o $${i}.c;\
		$(CXX) $(CFLAGS) -Wl,--gc-sections -o tool/`basename $${i}` $${i}.o ${objs} -L . $(LFLAGS);\
	done;
else
tool: $(objs) $(tool_objs)
	for i in $(tool_obj);\
                do echo $${i};\
                $(CC) $(CFLAGS) -Wl,--gc-sections -c -o $${i}.o $${i}.c;\
                $(CXX) $(CFLAGS) -Wl,--gc-sections -o tool/`basename $${i}` $${i}.o ${objs} -L . $(LFLAGS);\
        done;
endif
pre:
	cd ./third;tar -xvf speexdsp-1.2rc3.tar.gz


third/sqlite/sqlite3.o:./third/sqlite/sqlite3.c
	$(CC) -O3 -fPIC -DHAVE_POSIX_FALLOCATE -Wall -funroll-loops -Wno-unused-result -c -o $@ $<

${libusb}:
	cd ./third;tar -zxvf libusb-1.0.20.tar.gz;cd ./third/libusb-1.0.20;make -f makefile.linux CC=${CC} CXX=${CXX} AR=${CC_HOME}/bin/arm-linux-gnueabihf-ar clean all;

clean:
	-rm $(objs) $(libs)  


	
